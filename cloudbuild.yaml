options:
  logging: NONE


steps:
  # Step 1: Build and push Docker images for each microservice
  - name: 'gcr.io/cloud-builders/docker'
    dir: 'src/adservice'
    args: ['build', '-t', 'us-central1-docker.pkg.dev/peak-vortex-448111-j1/my-docker-repo/adservice:$(date +%Y%m%d%H%M%S)', '.']
  - name: 'gcr.io/cloud-builders/docker'
    dir: 'src/adservice'
    args: ['push', 'us-central1-docker.pkg.dev/peak-vortex-448111-j1/my-docker-repo/adservice:$(date +%Y%m%d%H%M%S)']
  # Repeat for other microservices
  - name: 'gcr.io/cloud-builders/docker'
    dir: 'src/cartservice'
    args: ['build', '-t', 'us-central1-docker.pkg.dev/peak-vortex-448111-j1/my-docker-repo/cartservice:$(date +%Y%m%d%H%M%S)', '.']
  - name: 'gcr.io/cloud-builders/docker'
    dir: 'src/cartservice'
    args: ['push', 'us-central1-docker.pkg.dev/peak-vortex-448111-j1/my-docker-repo/cartservice:$(date +%Y%m%d%H%M%S)']
  # Repeat for other microservices...

  # Step 2: Update Kubernetes manifests with new image tags
  - name: 'gcr.io/cloud-builders/gcloud'
    args:
      - 'sed'
      - '-i'
      - '-e'
      - 's|image: us-central1-docker.pkg.dev/.*/adservice:.*|image: us-central1-docker.pkg.dev/peak-vortex-448111-j1/my-repo/adservice:$(date +%Y%m%d%H%M%S)|'
      - 'kubernetes-manifests/adservice-deployment.yaml'
  # Repeat for other microservices' deployment YAML files...
  - name: 'gcr.io/cloud-builders/gcloud'
    args:
      - 'sed'
      - '-i'
      - '-e'
      - 's|image: us-central1-docker.pkg.dev/.*/cartservice:.*|image: us-central1-docker.pkg.dev/peak-vortex-448111-j1/my-repo/cartservice:$(date +%Y%m%d%H%M%S)|'
      - 'kubernetes-manifests/cartservice-deployment.yaml'

  # Step 3: Apply updated Kubernetes manifests
  - name: 'gcr.io/cloud-builders/kubectl'
    args: ['apply', '-f', 'kubernetes-manifests']
    env:
      - 'CLOUDSDK_CONTAINER_CLUSTER=my-gke-cluster'
      - 'CLOUDSDK_COMPUTE_ZONE=us-central1'

# Define the required substitutions (replace with actual values)
substitutions:
  _REGION: 'us-central1'
  _REPO: 'my-docker-repo'

# Specify artifacts to store the updated YAML files (optional)
artifacts:
  objects:
    location: 'gs://$PROJECT_ID-cloudbuild-artifacts/'
    paths:
      - 'kubernetes-manifests/*'
